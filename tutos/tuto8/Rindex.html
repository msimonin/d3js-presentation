<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3js</title>
    <script type="text/javascript" src="/lib/d3/d3.min.js"></script>
    <script type="text/javascript" src="/lib/dc.js"></script>
    <script type="text/javascript" src="/lib/crossfilter.js"></script>

    <link href="/css/dc.css" rel="stylesheet" type="text/css">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <style>
      .axis line,
      .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }


    </style>
  </head>
  <body>
    <h1>Tuto 8 : DC.js</h1>

    <div class="container">

      <div class="row"> 

        <div id="alt-chart">
          <div>
            <div><h3>Altitude <a class="reset" href="javascript:altChart.filterAll();dc.redrawAll();" style="display: none;">reset</a></h3>

            </div>  
          </div>
        </div>

        <div id="departements-chart"><h3>Departements  <a class="reset" href="javascript:departementsChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
          </h3> 
        </div>

      </div>

    </div>

    <div id="info"></div>

    <script type="text/javascript">

      var altChart = dc.barChart("#alt-chart");
      var departementsChart = dc.geoChoroplethChart("#departements-chart");


      d3.json("/datas/departements.json", function (depsJson) {
          departementsJson = depsJson; 
          render();
          });


function render() {
  d3.csv("/datas/villes_france.csv", function(d){
      var cities = d;
      var citiesx = crossfilter(cities);

      var altitudes = citiesx.dimension(function (d){
        return Math.floor(d["ville_zmin"]/10)*10;
        });

      var altitudesGroup = altitudes.group();


      altChart.width(500)
      .height(300)
      .dimension(altitudes)
      .group(altitudesGroup)
      .round(dc.round.floor)
      .elasticY(true)
      .x(d3.scale.linear().domain([0,1800]))
      .margins({top: 10, left: 50, right: 10, bottom:50})
      .xAxisLabel("Altitude min (m)")
      .yAxisLabel("# villes")


      departements = citiesx.dimension(function (d) {
          return d["departement"];
          });

  console.log(departements)

    departementsGroup = departements.group();
  departementsGroup2 = departements.group().reduce(add, remove, init);

  function add(p, v) {
    return p + parseInt(v.population_2010);
  }

  function remove(p, v) {
    return p - parseInt(v.population_2010);
  }

  function init(){
    return 0;
  }


  projection = d3.geo.conicConformal()
    .center([7.454071, 47.279229]) // On centre la carte sur la France
    .scale(3100);

  departementsChart.width(600)
    .height(600)
    .dimension(departements)
    .group(departementsGroup2)
    .colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
    .colorDomain([0, 3000000])
    .colorCalculator(function (d) { return d ? departementsChart.colors()(d) : '#ccc'; })
    .overlayGeoJson(departementsJson.features, "CODE_DEPT", function (d) {
        return d.properties["CODE_DEPT"];
        })
  .title(function (d) {
      return d.key + "/"  + d.value;
      })
  .projection(projection);

  dc.renderAll();
  });
}

</script>
    </body>
  </html>
